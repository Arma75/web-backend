<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.attickok.playlist.playlist.mapper.PlaylistMapper">
    <sql id="whereConditions">
        <where>
          <if test="genre != null and genre != ''">
           AND GENRE LIKE '%' || #{genre} || '%'
          </if>
          <if test="artist != null and artist != ''">
           AND ARTIST LIKE '%' || #{artist} || '%'
          </if>
          <if test="songTitle != null and songTitle != ''">
           AND SONG_TITLE LIKE '%' || #{songTitle} || '%'
          </if>
          <if test="useYn != null and useYn != ''">
           AND USE_YN = #{useYn}
          </if>
          <if test="regDtmStart != null">
           AND REG_DTM <![CDATA[>=]]> #{regDtmStart}
          </if>
          <if test="regDtmEnd != null">
           AND REG_DTM <![CDATA[<=]]> #{regDtmEnd}
          </if>
          <if test="updDtmStart != null">
           AND UPD_DTM <![CDATA[>=]]> #{updDtmStart}
          </if>
          <if test="updDtmEnd != null">
           AND UPD_DTM <![CDATA[<=]]> #{updDtmEnd}
          </if>
        </where>
    </sql>

    <insert id="create" parameterType="com.attickok.playlist.playlist.dto.PlaylistSaveRequest" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO PLAYLIST
        (
              GENRE
            , ARTIST
            , SONG_TITLE
            , USE_YN
        )
        VALUES
        (
              #{genre}
            , #{artist}
            , #{songTitle}
            , COALESCE(#{useYn}, 'Y')
        )
    </insert>

    <insert id="createBulk" parameterType="java.util.List">
        INSERT INTO PLAYLIST
        (
              GENRE
            , ARTIST
            , SONG_TITLE
            , USE_YN
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
                  #{item.genre}
                , #{item.artist}
                , #{item.songTitle}
                , COALESCE(#{item.useYn}, 'Y')
            )
        </foreach>
    </insert>

    <select id="findById" parameterType="long" resultType="com.attickok.playlist.playlist.dto.PlaylistResponse">
        SELECT ID
             , GENRE
             , ARTIST
             , SONG_TITLE
             , USE_YN
             , REG_DTM
             , UPD_DTM
          FROM PLAYLIST
         WHERE ID = #{id}
    </select>

    <select id="findAll" parameterType="com.attickok.playlist.playlist.dto.PlaylistSearchRequest" resultType="com.attickok.playlist.playlist.dto.PlaylistResponse">
        SELECT ID
             , GENRE
             , ARTIST
             , SONG_TITLE
             , USE_YN
             , REG_DTM
             , UPD_DTM
          FROM PLAYLIST
        <include refid="whereConditions" />
        ORDER BY 
        <choose>
          <when test="sort != null and sort != ''">
            ${sort} 
          </when>
          <otherwise>
            ID DESC
          </otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countAll" parameterType="com.attickok.playlist.playlist.dto.PlaylistSearchRequest" resultType="long">
        SELECT COUNT(*)
          FROM PLAYLIST
        <include refid="whereConditions" />
    </select>

    <update id="update" parameterType="com.attickok.playlist.playlist.dto.PlaylistSaveRequest">
        UPDATE PLAYLIST
           SET UPD_DTM = CURRENT_TIMESTAMP
             , GENRE = #{genre}
             , ARTIST = #{artist}
             , SONG_TITLE = #{songTitle}
             , USE_YN = #{useYn}
         WHERE ID = #{id}
    </update>

    <update id="updateBulk" parameterType="java.util.List">
        <foreach collection="list" item="item" separator=";">
            UPDATE PLAYLIST
               SET UPD_DTM = CURRENT_TIMESTAMP
                 , GENRE = #{item.genre}
                 , ARTIST = #{item.artist}
                 , SONG_TITLE = #{item.songTitle}
                 , USE_YN = #{item.useYn}
             WHERE ID = #{item.id}
        </foreach>
    </update>

    <update id="patch" parameterType="com.attickok.playlist.playlist.dto.PlaylistSaveRequest">
        UPDATE PLAYLIST
           SET UPD_DTM = CURRENT_TIMESTAMP
          <if test="genre != null">
             , GENRE = #{genre}
          </if>
          <if test="artist != null">
             , ARTIST = #{artist}
          </if>
          <if test="songTitle != null">
             , SONG_TITLE = #{songTitle}
          </if>
          <if test="useYn != null">
             , USE_YN = #{useYn}
          </if>
         WHERE ID = #{id}
    </update>

    <update id="patchBulk" parameterType="java.util.List">
        <foreach collection="list" item="item" separator=";">
            UPDATE PLAYLIST
               SET UPD_DTM = CURRENT_TIMESTAMP
              <if test="item.genre != null">
                 , GENRE = #{item.genre}
              </if>
              <if test="item.artist != null">
                 , ARTIST = #{item.artist}
              </if>
              <if test="item.songTitle != null">
                 , SONG_TITLE = #{item.songTitle}
              </if>
              <if test="item.useYn != null">
                 , USE_YN = #{item.useYn}
              </if>
             WHERE ID = #{item.id}
        </foreach>
    </update>

    <update id="unuse" parameterType="long">
        UPDATE PLAYLIST 
           SET UPD_DTM = CURRENT_TIMESTAMP
             , USE_YN = 'N'
         WHERE ID = #{id}
    </update>

    <update id="unuseBulk" parameterType="java.util.List">
        UPDATE PLAYLIST 
           SET UPD_DTM = CURRENT_TIMESTAMP
             , USE_YN = 'N'
         WHERE ID IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    
    <delete id="delete" parameterType="long">
        DELETE
          FROM PLAYLIST
         WHERE ID = #{id}
    </delete>
    
    <delete id="deleteBulk" parameterType="java.util.List">
        DELETE
          FROM PLAYLIST
         WHERE ID IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

</mapper>